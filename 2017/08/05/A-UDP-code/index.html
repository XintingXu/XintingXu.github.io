<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="个人博客"><meta name="keywords" content="博客, 开发, 计算机, 编程"><title>一个简单的UDP测试程序 | 雁家</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">一个简单的UDP测试程序</h1><a id="logo" href="/.">雁家</a><p class="description">徐欣廷的自留地</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">一个简单的UDP测试程序</h1><div class="post-meta"><a href="/2017/08/05/A-UDP-code/#comments" class="comment-count"><a id="uyan_count_unit" href="/2017/08/05/A-UDP-code/"></a>留言</a><p><span class="date">Aug 05, 2017</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h1 id="一个简单的UDP测试程序"><a href="#一个简单的UDP测试程序" class="headerlink" title="一个简单的UDP测试程序"></a>一个简单的UDP测试程序</h1><h2 id="功能介绍"><a href="#功能介绍" class="headerlink" title="功能介绍"></a>功能介绍</h2><p>这是一个简单的UDP测试程序，用于UDP数据包的发送、接收测试。</p>
<h4 id="它能干什么？"><a href="#它能干什么？" class="headerlink" title="它能干什么？"></a>它能干什么？</h4><p>它集成了客户端和服务端两个部分，可以通过命令行的启动参数进行状态转换。</p>
<p>它可以按照一定的时间进行UDP数据包的发送，也可以设定发送的UDP数据包的负载长度，当然也可以设定每一轮发送数据包的数量。此外，服务进程监听的端口号及客户进程发送时的目标端口也是可以设定的。</p>
<p>不过，需要确定的是，发送时的IP地址和端口号必须是可连通的。比如，发送端和接收端的设备应该处于同一个子网中，如果发生跨子网的情况，则无法成功进行数据传送。</p>
<h2 id="代码展示"><a href="#代码展示" class="headerlink" title="代码展示"></a>代码展示</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div></pre></td><td class="code"><pre><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;getopt.h&gt;</div><div class="line">#include &lt;stdbool.h&gt;</div><div class="line">#include &lt;string.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include &lt;pthread.h&gt;</div><div class="line"></div><div class="line">#include &lt;sys/types.h&gt;</div><div class="line">#include &lt;sys/socket.h&gt;</div><div class="line">#include &lt;netinet/in.h&gt;</div><div class="line">#include &lt;arpa/inet.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;fcntl.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;sys/time.h&gt;</div><div class="line">#include &lt;time.h&gt;</div><div class="line"></div><div class="line">char *l_opt_arg;</div><div class="line">char* const short_options = &quot;c:l:i:srhp:a:y:&quot;;</div><div class="line"></div><div class="line">/*</div><div class="line">struct option</div><div class="line">&#123;</div><div class="line">  const char *name;</div><div class="line">  int has_arg;</div><div class="line">  int *flag;</div><div class="line">  int val;</div><div class="line">&#125;;</div><div class="line">*/</div><div class="line">struct option long_options[] = &#123;</div><div class="line">&#123; &quot;count&quot;, 1, NULL, &apos;c&apos; &#125;,</div><div class="line">&#123; &quot;length&quot;, 1, NULL, &apos;l&apos; &#125;,</div><div class="line">&#123; &quot;interval&quot;, 1, NULL, &apos;i&apos; &#125;,</div><div class="line">&#123; &quot;port&quot;, 1, NULL, &apos;p&apos; &#125;,</div><div class="line">&#123; &quot;ip&quot;, 1, NULL, &apos;a&apos; &#125;,</div><div class="line">&#123; &quot;cycles&quot;, 1, NULL, &apos;y&apos; &#125;,</div><div class="line">&#123; &quot;send&quot;, 0, NULL, &apos;s&apos; &#125;,</div><div class="line">&#123; &quot;receive&quot;, 0, NULL, &apos;r&apos; &#125;,</div><div class="line">&#123; &quot;help&quot;, 0, NULL, &apos;h&apos; &#125;,</div><div class="line">&#123; 0, 0, 0, 0&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">void printHelp();</div><div class="line"></div><div class="line">struct ControlArguments&#123;</div><div class="line">    bool isSend;</div><div class="line">    bool isReceive;</div><div class="line">    int SendCount;    //packets to send at one time,only for send option,default 1</div><div class="line">    int PacketLength;   //data length in UDP packet,only for send option,default 100</div><div class="line">    int Interval;   //time between send cycles.default is 20ms,only for send option</div><div class="line">    int Port;   //port used for transmit</div><div class="line">    int Cycles; //operation cycles,only for send option,default 10</div><div class="line">    char IP[15];  //target ip address,only for send option</div><div class="line">&#125;;</div><div class="line"></div><div class="line">void sendUDP(struct ControlArguments * const);</div><div class="line">void receiveUDP(struct ControlArguments * const);</div><div class="line"></div><div class="line">void initControlArguments(struct ControlArguments * const controlArguments)&#123;</div><div class="line">    controlArguments-&gt;isSend = false;</div><div class="line">    controlArguments-&gt;isReceive = false;</div><div class="line">    controlArguments-&gt;SendCount = 1;</div><div class="line">    controlArguments-&gt;PacketLength = 100;</div><div class="line">    controlArguments-&gt;Interval = 20;</div><div class="line">    controlArguments-&gt;Port = 0;</div><div class="line">    controlArguments-&gt;Cycles = 10;</div><div class="line">    controlArguments-&gt;IP[0] = &apos;\0&apos;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int charPoint2Int(char const * string)&#123;</div><div class="line">    return atoi(string);</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main(int argc, char *argv[])</div><div class="line">&#123;</div><div class="line">    int c;</div><div class="line">    int index=0;</div><div class="line">    bool argumentOK = true;</div><div class="line">    static struct ControlArguments  controlArguments;</div><div class="line">    initControlArguments(&amp;controlArguments);</div><div class="line">    while((c = getopt_long (argc, argv, short_options, long_options, &amp;index)) != -1)</div><div class="line">    &#123;</div><div class="line">        switch (c)</div><div class="line">        &#123;</div><div class="line">        case &apos;s&apos;:</div><div class="line">            printf(&quot;Send\n&quot;);</div><div class="line">            controlArguments.isSend = true;</div><div class="line">            break;</div><div class="line">        case &apos;r&apos;:</div><div class="line">            printf(&quot;Receive\n&quot;);</div><div class="line">            controlArguments.isReceive = true;</div><div class="line">            break;</div><div class="line">        case &apos;c&apos;:</div><div class="line">            l_opt_arg = optarg;</div><div class="line">            printf(&quot;Send Count : %s\n&quot;, l_opt_arg);</div><div class="line">            controlArguments.SendCount = charPoint2Int(l_opt_arg);</div><div class="line">            break;</div><div class="line">        case &apos;y&apos;:</div><div class="line">            l_opt_arg = optarg;</div><div class="line">            printf(&quot;Send Cycles : %s\n&quot;, l_opt_arg);</div><div class="line">            controlArguments.Cycles = charPoint2Int(l_opt_arg);</div><div class="line">            break;</div><div class="line">        case &apos;l&apos;:</div><div class="line">            l_opt_arg = optarg;</div><div class="line">            printf(&quot;Packet Length : %s\n&quot;,l_opt_arg);</div><div class="line">            controlArguments.PacketLength = charPoint2Int(l_opt_arg);</div><div class="line">            break;</div><div class="line">        case &apos;i&apos;:</div><div class="line">            l_opt_arg = optarg;</div><div class="line">            printf(&quot;Interval Time : %s\n&quot;,l_opt_arg);</div><div class="line">            controlArguments.Interval = charPoint2Int(l_opt_arg);</div><div class="line">            break;</div><div class="line">        case &apos;h&apos;:</div><div class="line">            printHelp();</div><div class="line">            break;</div><div class="line">        case &apos;p&apos;:</div><div class="line">            l_opt_arg = optarg;</div><div class="line">            printf(&quot;Chosen Port : %s\n&quot;,l_opt_arg);</div><div class="line">            controlArguments.Port = charPoint2Int(l_opt_arg);</div><div class="line">            break;</div><div class="line">        case &apos;a&apos;:</div><div class="line">            l_opt_arg = optarg;</div><div class="line">            printf(&quot;Target IP : %s\n&quot;,l_opt_arg);</div><div class="line">            strncpy(controlArguments.IP,l_opt_arg,15);</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            printf(&quot;Do not match!!!\n&quot;);</div><div class="line">            argumentOK = false;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if(argumentOK)&#123;</div><div class="line">        if(controlArguments.isSend &amp;&amp; !controlArguments.isReceive)&#123;</div><div class="line">            printf(&quot;choosing send\n&quot;);</div><div class="line">            sendUDP(&amp;controlArguments);</div><div class="line">        &#125;else if(controlArguments.isReceive &amp;&amp; !controlArguments.isSend)&#123;</div><div class="line">            printf(&quot;choosing receive\n&quot;);</div><div class="line">            receiveUDP(&amp;controlArguments);</div><div class="line">        &#125;else&#123;</div><div class="line">            printf(&quot;**************************\n&quot;);</div><div class="line">            printf(&quot;Arguments Error!    both send and receive.\n&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;else&#123;</div><div class="line">        printf(&quot;************************************************\n&quot;);</div><div class="line">        printHelp();</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void printHelp()&#123;</div><div class="line">    printf(&quot;Help Menu:\n  Argument reference list:\n&quot;);</div><div class="line">    printf(&quot;    -s  :send UDP packets.\n&quot;);</div><div class="line">    printf(&quot;    -r  :receive UDP packets.\n&quot;);</div><div class="line">    printf(&quot;    -c --count  :packets to send one cycle.default is 1.\n&quot;);</div><div class="line">    printf(&quot;    -y --cycles  :send cycles.default is 10.\n&quot;);</div><div class="line">    printf(&quot;    -l --length  :data length in udp packet.default is 100bytes.\n&quot;);</div><div class="line">    printf(&quot;    -i --interval  :milliseconds between send options.default is 20ms.\n&quot;);</div><div class="line">    printf(&quot;    -a --ip  :ip address to operate.\n&quot;);</div><div class="line">    printf(&quot;    -p --port  :port used for UDP socket.\n&quot;);</div><div class="line">    printf(&quot;    -h --help  :command help.\n&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">/*</div><div class="line">Check IP Format</div><div class="line">if format error return false;</div><div class="line">if format check passed return true;</div><div class="line"></div><div class="line">argument is the pointer to the IP string.</div><div class="line">*/</div><div class="line">bool IPFormatCheck(char * const IP)&#123;</div><div class="line">    printf(&quot;IP check\n&quot;);</div><div class="line"></div><div class="line">    int ip_length = strlen(IP);</div><div class="line">    bool checkError = false;</div><div class="line">    int count_s = 0;</div><div class="line"></div><div class="line">    for(int i = 0,interval = 0 ; i &lt; ip_length ; ++ i)&#123;</div><div class="line">        if(IP[i] == &apos;.&apos;)&#123;</div><div class="line">            if(interval == 0 || interval &gt; 3)&#123;</div><div class="line">                checkError = true;</div><div class="line">                break;</div><div class="line">            &#125;else&#123;</div><div class="line">                ++ count_s;</div><div class="line">                interval = 0;</div><div class="line">            &#125;</div><div class="line">        &#125;else if(IP[i] &gt;= &apos;0&apos; &amp;&amp; IP[i] &lt;= &apos;9&apos;)&#123;</div><div class="line">            ++ interval;</div><div class="line">        &#125;else&#123;</div><div class="line">            checkError = true;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if(count_s != 3)&#123;</div><div class="line">        checkError = true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return (!checkError);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">/*</div><div class="line">Check Arguments for send Process</div><div class="line">if check passed return true;</div><div class="line">if check failed return false;</div><div class="line"></div><div class="line">argument is the pointer to struct ControlArguments.</div><div class="line">*/</div><div class="line">bool checkSendConfig(struct ControlArguments * const controlArguments)&#123;</div><div class="line">    printf(&quot;checking arguments.\n&quot;);</div><div class="line">    bool returnVaule;</div><div class="line"></div><div class="line">    char * IP;</div><div class="line">    IP = malloc(sizeof(strlen(controlArguments-&gt;IP)) + 1);</div><div class="line">    strncpy(IP,controlArguments-&gt;IP,15);</div><div class="line">    if(strlen(IP) != 0)&#123;</div><div class="line">        if(IPFormatCheck(IP))&#123;</div><div class="line">            if((controlArguments-&gt;Port == 0) || (controlArguments-&gt;PacketLength == 0))&#123;</div><div class="line">                printf(&quot;Port:%d  Length:%d\n&quot;,controlArguments-&gt;Port,controlArguments-&gt;PacketLength);</div><div class="line">                printf(&quot;[Error] : Port or PacketLength Error.\n&quot;);</div><div class="line">                returnVaule = false;</div><div class="line">            &#125;else&#123;</div><div class="line">                returnVaule = true;</div><div class="line">            &#125;</div><div class="line">        &#125;else&#123;</div><div class="line">            printf(&quot;[Error] : IP Error\n&quot;);</div><div class="line">            returnVaule = false;</div><div class="line">        &#125;</div><div class="line">    &#125;else&#123;</div><div class="line">        printf(&quot;[Error] : IP length = 0!\n&quot;);</div><div class="line">        returnVaule = false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    free(IP);</div><div class="line"></div><div class="line">    return returnVaule;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void threadSend(struct ControlArguments * const controlArguments)&#123;</div><div class="line">    printf(&quot;****************************************\nSending Thread Start\n&quot;);</div><div class="line"></div><div class="line">    //定义sockfd</div><div class="line">    int sock_cli = socket(AF_INET,SOCK_DGRAM, 0);</div><div class="line"></div><div class="line">    //定义sockaddr_in</div><div class="line">    struct sockaddr_in servaddr;</div><div class="line">    memset(&amp;servaddr, 0, sizeof(servaddr));</div><div class="line">    servaddr.sin_family = AF_INET;</div><div class="line">    servaddr.sin_port = htons(controlArguments-&gt;Port);  //服务器端口</div><div class="line">    servaddr.sin_addr.s_addr = inet_addr(controlArguments-&gt;IP);  //服务器ip</div><div class="line"></div><div class="line">    struct timeval time;</div><div class="line"></div><div class="line">    //连接服务器，成功返回0，错误返回-1</div><div class="line">    if (connect(sock_cli, (struct sockaddr *)&amp;servaddr, sizeof(servaddr)) != 0)</div><div class="line">    &#123;</div><div class="line">        perror(&quot;connect&quot;);</div><div class="line">    &#125;else&#123;</div><div class="line"></div><div class="line">        char *sendbuf = malloc(controlArguments-&gt;PacketLength);</div><div class="line"></div><div class="line">        for(int i = 0 ; i &lt; controlArguments-&gt;PacketLength - 1 ; i++)&#123;</div><div class="line">            gettimeofday(&amp;time,NULL);</div><div class="line">            int seed = time.tv_usec + i;</div><div class="line">            sendbuf[i] = rand_r(&amp;seed) % 93 + 33;</div><div class="line">        &#125;</div><div class="line">        sendbuf[controlArguments-&gt;PacketLength - 1] = &apos;\0&apos;;</div><div class="line">        printf(&quot;buf : %s\n&quot;,sendbuf);</div><div class="line">        useconds_t sleep_us = (unsigned int)controlArguments-&gt;Interval * 1000;</div><div class="line"></div><div class="line">        int pack_seq = 0;</div><div class="line"></div><div class="line">        for(int i = 0  ; i &lt; controlArguments-&gt;Cycles ; ++ i)&#123;</div><div class="line">            for(int j = 0 ; j &lt; controlArguments-&gt;SendCount ; j++)&#123;</div><div class="line">                char *realSend = malloc((strlen(sendbuf) + 20));</div><div class="line">                if(realSend)&#123;</div><div class="line">                    gettimeofday(&amp;time,NULL);</div><div class="line">                    sprintf(realSend,&quot;[%4ld.%06ld][%4d]:%s&quot;,time.tv_sec,time.tv_usec,++pack_seq,sendbuf);</div><div class="line"></div><div class="line">                    if(send(sock_cli, realSend, strlen(realSend),0) &gt; 0)&#123;</div><div class="line">                        printf(&quot;Send Successful\n&quot;);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    free(realSend);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            usleep(sleep_us);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        free(sendbuf);</div><div class="line">//        printf(&quot;free.\n&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    close(sock_cli);</div><div class="line">    printf(&quot;Sending Thread Finish\n****************************************\n&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void sendUDP(struct ControlArguments * const controlArguments)&#123;</div><div class="line">    if(checkSendConfig(controlArguments))&#123;</div><div class="line">//        pthread_t tid;</div><div class="line">        printf(&quot;Before Send Thread\n&quot;);</div><div class="line">//        pthread_create(&amp;tid, NULL, threadSend(controlArguments), NULL);</div><div class="line">//        pthread_tryjoin_np(tid, NULL);</div><div class="line">        threadSend(controlArguments);</div><div class="line">        printf(&quot;After Send Thread\n&quot;);</div><div class="line">    &#125;else&#123;</div><div class="line">        ;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">bool checkReceiveConfig(struct ControlArguments * const controlArguments)&#123;</div><div class="line">    if(controlArguments-&gt;Port == 0)&#123;</div><div class="line">        printf(&quot;[Error] : Please set Listening port.\n&quot;);</div><div class="line">        return false;</div><div class="line">    &#125;else&#123;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void threadReceive(struct ControlArguments * const controlArguments)&#123;</div><div class="line">    printf(&quot;****************************************\nReceiving Thread Start\n&quot;);</div><div class="line">    //定义sockfd</div><div class="line">    int server_sockfd = socket(AF_INET,SOCK_DGRAM, 0);</div><div class="line">    static int recive_serial = 0;</div><div class="line"></div><div class="line">    if(server_sockfd &lt; 0)&#123;</div><div class="line">        perror(&quot;socket&quot;);</div><div class="line">    &#125;else&#123;</div><div class="line">        //定义sockaddr_in</div><div class="line">        struct sockaddr_in server_sockaddr;</div><div class="line">        struct sockaddr_in client_addr;</div><div class="line">        memset(&amp;server_sockaddr,0,sizeof(struct sockaddr_in));</div><div class="line">        server_sockaddr.sin_family = AF_INET;</div><div class="line">        server_sockaddr.sin_port = htons(controlArguments-&gt;Port);</div><div class="line">        server_sockaddr.sin_addr.s_addr = htonl(INADDR_ANY);</div><div class="line"></div><div class="line">        //bind，成功返回0，出错返回-1</div><div class="line">        if(bind(server_sockfd,(struct sockaddr *)&amp;server_sockaddr,sizeof(server_sockaddr))==-1)&#123;</div><div class="line">            perror(&quot;bind&quot;);</div><div class="line">        &#125;else&#123;</div><div class="line">            //客户端套接字</div><div class="line">            char buffer[1024];</div><div class="line">            socklen_t length = sizeof(client_addr);</div><div class="line">            int recv_len = 0;</div><div class="line"></div><div class="line">            struct timeval time;</div><div class="line"></div><div class="line">            while(1)&#123;</div><div class="line">                //成功返回非负描述字，出错返回-1</div><div class="line">                recv_len = recvfrom(server_sockfd,buffer,sizeof(buffer),0,(struct sockaddr *)&amp;client_addr,&amp;length);</div><div class="line">                gettimeofday(&amp;time,NULL);</div><div class="line"></div><div class="line">                if(recv_len &gt;= 0)&#123;</div><div class="line">                    ++ recive_serial;</div><div class="line">                    printf(&quot;[%8ld.%06ld]Get[%d][l:%d] : %s\n&quot;,time.tv_sec,time.tv_usec,recive_serial,recv_len,buffer);</div><div class="line">                &#125;</div><div class="line">                memset(&amp;buffer,0,sizeof(buffer));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    close(server_sockfd);</div><div class="line">    printf(&quot;Receiving Thread Finish\n****************************************\n&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void receiveUDP(struct ControlArguments * const controlArguments)&#123;</div><div class="line">    if(checkReceiveConfig(controlArguments))&#123;</div><div class="line">//        pthread_t tid;</div><div class="line">        printf(&quot;Before Thread\n&quot;);</div><div class="line">//        pthread_create(&amp;tid, NULL, threadReceive(controlArguments), NULL);</div><div class="line">//        pthread_tryjoin_np(tid, NULL);</div><div class="line">        threadReceive(controlArguments);</div><div class="line">        printf(&quot;After Thread\n&quot;);</div><div class="line">    &#125;else&#123;</div><div class="line">        ;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="函数解析"><a href="#函数解析" class="headerlink" title="函数解析"></a>函数解析</h2><h4 id="1-main-int-argc-char-argv"><a href="#1-main-int-argc-char-argv" class="headerlink" title="1.main(int argc, char *argv[])"></a>1.main(int argc, char *argv[])</h4><pre><code>int main(int argc, char *argv[])
</code></pre><p>主函数，用于接收参数和命令行解析。采用了getopt.h中提供的参数解析功能。可以像Linux自带的命令工具一样，可以通过短参或长参进行运行时的参数设定。</p>
<p>采用的参数设定方式可以调用短参数－ｈ进行查看。默认的参数设定方式如下：</p>
<pre><code>-s  :send UDP packets.
-r  :receive UDP packets.
-c --count  :packets to send one cycle.default is 1.
-y --cycles  :send cycles.default is 10.
-l --length  :data length in udp packet.default is 100bytes.
-i --interval  :milliseconds between send options.default is 20ms.
-a --ip  :ip address to operate.
-p --port  :port used for UDP socket.
-h --help  :command help.
</code></pre><h4 id="2．IPFormatCheck-char-const-IP"><a href="#2．IPFormatCheck-char-const-IP" class="headerlink" title="2．IPFormatCheck(char * const IP)"></a>2．IPFormatCheck(char * const IP)</h4><pre><code>bool　IPFormatCheck(char * const IP)
</code></pre><p>IP格式检查函数，传入的参数是输入的IP字符串，返回的是检查结果。如果IP字符串符合IP的书写格式，返回true；如果IP字符串出现错误，返回false。</p>
<p>该检查函数仅面向IPv4，如果输入的地址是IPv6，将返回false。</p>
<h4 id="3．checkSendConfig-struct-ControlArguments-const-controlArguments"><a href="#3．checkSendConfig-struct-ControlArguments-const-controlArguments" class="headerlink" title="3．checkSendConfig(struct ControlArguments * const controlArguments)"></a>3．checkSendConfig(struct ControlArguments * const controlArguments)</h4><pre><code>bool　checkSendConfig(struct ControlArguments * const controlArguments)
</code></pre><p>发送参数检查，传入的参数是ControlArguments结构体指针，如果参数完备，返回true；如果参数出现冲突或者错误，返回false。</p>
<p>检查过程中，需要检查设定的IP地址，目标端口地址。如果任何一个参数出现错误，将返回false。</p>
<h4 id="4．checkReceiveConfig-struct-ControlArguments-const-controlArguments"><a href="#4．checkReceiveConfig-struct-ControlArguments-const-controlArguments" class="headerlink" title="4．checkReceiveConfig(struct ControlArguments * const controlArguments)"></a>4．checkReceiveConfig(struct ControlArguments * const controlArguments)</h4><pre><code>bool checkReceiveConfig(struct ControlArguments * const controlArguments)
</code></pre><p>监听参数检查，因为监听的是本地端口，所以只要本地端口号不为空即可。</p>
<p>传入的参数是ControlArguments结构体指针，返回值为true或者false。</p>
<h4 id="5．threadSend-struct-ControlArguments-const-controlArguments"><a href="#5．threadSend-struct-ControlArguments-const-controlArguments" class="headerlink" title="5．threadSend(struct ControlArguments * const controlArguments)"></a>5．threadSend(struct ControlArguments * const controlArguments)</h4><pre><code>void threadSend(struct ControlArguments * const controlArguments)
</code></pre><p>UDP数据包发送函数，可以作为单独的线程运行。传入的参数为ControlArguments结构体指针，根据设定的发送轮次和间隔、计数进行一次发送过程。</p>
<div id="flowchart-0" class="flow-chart"></div>

<p>在UDP的数据负载设定中，采用了随机填充的方法，通过随机数到ASCII码的映射，实现定长负载的内容生成。</p>
<h4 id="6．threadReceive-struct-ControlArguments-const-controlArguments"><a href="#6．threadReceive-struct-ControlArguments-const-controlArguments" class="headerlink" title="6．threadReceive(struct ControlArguments * const controlArguments)"></a>6．threadReceive(struct ControlArguments * const controlArguments)</h4><pre><code>void threadReceive(struct ControlArguments * const controlArguments)
</code></pre><p><div id="flowchart-1" class="flow-chart"></div><br>socket处于轮询等待的状态，不断从缓冲区中读取数据包。在接收到数据包后，根据当前的时间添加接收时间戳，用于传输的评估。</p>
<h4 id="7．sendUDP-struct-ControlArguments-const-controlArguments"><a href="#7．sendUDP-struct-ControlArguments-const-controlArguments" class="headerlink" title="7．sendUDP(struct ControlArguments * const controlArguments)"></a>7．sendUDP(struct ControlArguments * const controlArguments)</h4><pre><code>void sendUDP(struct ControlArguments * const controlArguments)
</code></pre><p>该函数用于调用threadSend函数，在具备pthread支持的环境中，可以将发送线程作为子线程处理。因为此处不具备多线程优化的意义，所以暂时将相关功能屏蔽。</p>
<h4 id="8．receiveUDP-struct-ControlArguments-const-controlArguments"><a href="#8．receiveUDP-struct-ControlArguments-const-controlArguments" class="headerlink" title="8．receiveUDP(struct ControlArguments * const controlArguments)"></a>8．receiveUDP(struct ControlArguments * const controlArguments)</h4><pre><code>void receiveUDP(struct ControlArguments * const controlArguments)
</code></pre><p>该函数用于调用threadReceive函数，代码中设计使用pthread进行子线程处理，因为此处多线程效果有限，相关功能暂时屏蔽。<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script><textarea id="flowchart-0-code" style="display: none">st=>start: socket接口初始化
en=>end: 结束
op1=>operation: 连接服务器
op2=>operation: 设定发送缓冲区
op3=>operation: 随机填充发送内容
op4=>operation: 轮次发送
op5=>operation: 关闭socket

st->op1
op1->op2
op1->op5
op2->op3
op3->op4
op4->en
op5->en

socket接口初始化-->连接服务器
连接服务器-->设定发送缓冲区
连接服务器-->关闭socket
设定发送缓冲区-->随机填充发送内容
随机填充发送内容-->轮次发送
轮次发送-->结束
关闭socket-->结束</textarea><textarea id="flowchart-0-options" style="display: none">{"scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script><textarea id="flowchart-1-code" style="display: none">graph TB
打开socket-->定义输入参数
定义输入参数-->ｂｉｎｄ参数
ｂｉｎｄ参数-->等待数据包
等待数据包-->数据处理及添加时间戳
数据处理及添加时间戳-->等待数据包
数据处理及添加时间戳-->结束</textarea><textarea id="flowchart-1-options" style="display: none">{"scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-1-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-1-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-1", options);</script></p>
</div><div class="tags"></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div id="comments"><div id="uyan_frame"></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一个简单的UDP测试程序"><span class="toc-text">一个简单的UDP测试程序</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#功能介绍"><span class="toc-text">功能介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#它能干什么？"><span class="toc-text">它能干什么？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码展示"><span class="toc-text">代码展示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#函数解析"><span class="toc-text">函数解析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-main-int-argc-char-argv"><span class="toc-text">1.main(int argc, char *argv[])</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2．IPFormatCheck-char-const-IP"><span class="toc-text">2．IPFormatCheck(char * const IP)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3．checkSendConfig-struct-ControlArguments-const-controlArguments"><span class="toc-text">3．checkSendConfig(struct ControlArguments * const controlArguments)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4．checkReceiveConfig-struct-ControlArguments-const-controlArguments"><span class="toc-text">4．checkReceiveConfig(struct ControlArguments * const controlArguments)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5．threadSend-struct-ControlArguments-const-controlArguments"><span class="toc-text">5．threadSend(struct ControlArguments * const controlArguments)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6．threadReceive-struct-ControlArguments-const-controlArguments"><span class="toc-text">6．threadReceive(struct ControlArguments * const controlArguments)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7．sendUDP-struct-ControlArguments-const-controlArguments"><span class="toc-text">7．sendUDP(struct ControlArguments * const controlArguments)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8．receiveUDP-struct-ControlArguments-const-controlArguments"><span class="toc-text">8．receiveUDP(struct ControlArguments * const controlArguments)</span></a></li></ol></li></ol></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/08/05/A-UDP-code/">一个简单的UDP测试程序</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://www.07111301.com" title="永远的07111301" target="_blank">永远的07111301</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">XintingXu.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script><script src="http://v2.uyan.cc/code/uyan.js?uid=2140237"></script></body></html>